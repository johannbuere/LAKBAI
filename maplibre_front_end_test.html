<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LAKBAI Navigation Test</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@mapbox/polyline"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>

    // Initialize MapLibre

    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json',
      center: [123.7438, 13.1391], // Legazpi City
      zoom: 11,
      maxBounds: [ // Limit lang toh sa Albay area
        [123.3, 12.9],  // SW corner (Albay approx)
        [124.1, 13.6]   // NE corner (Albay approx)
      ]
    });


    // Fetch route from Valhalla (not yet yet due to CORS issues)
   
    async function getRoute(start, end) {
      const body = {
        locations: [
          { lat: start[1], lon: start[0] },
          { lat: end[1], lon: end[0] }
        ],
        costing: "auto",
        directions_options: { units: "kilometers" }
      };

      try {
        const res = await fetch("http://localhost:8002/route", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        console.log("Valhalla response:", data);

        const shape = polyline.decode(data.trip.legs[0].shape);
        return shape.map(([lat, lon]) => [lon, lat]); // convert to [lon,lat]
      } catch (err) {
        console.error("Valhalla request failed:", err);
        return [];
      }
    }

    // Draw route on map (ito rin, di pa gumagana)

    async function drawRoute(start, end) {
      const coords = await getRoute(start, end);

      if (coords.length === 0) return;

      const geojson = {
        type: "Feature",
        geometry: {
          type: "LineString",
          coordinates: coords
        }
      };

      if (map.getSource("route")) {
        map.getSource("route").setData(geojson);
      } else {
        map.addSource("route", { type: "geojson", data: geojson });
        map.addLayer({
          id: "route-line",
          type: "line",
          source: "route",
          paint: {
            "line-color": "#1d3557",
            "line-width": 4
          }
        });
      }
    }

    // Example on load

    map.on("load", async () => {
      const start = [123.7438, 13.1391]; // Legazpi downtown
      const end   = [123.6927, 13.1817]; // Cagsawa Ruins
      await drawRoute(start, end);

      // Markers
      new maplibregl.Marker({ color: "green" }).setLngLat(start).addTo(map);
      new maplibregl.Marker({ color: "red" }).setLngLat(end).addTo(map);
    });
  </script>
</body>
</html>
